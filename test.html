<?php


// if there is a query string in the URL (?loggedin=true), it will set 2 cookies for the entire site:
// The users email, and a loggedIn=true, which will be used to keep the site facing a logged in user
if (!empty($_GET)) {
    $dbServerName = "localhost";
    $dbUsername = "root";
    $dbPassword = "";
    $dbName = "project";
    $connection = mysqli_connect($dbServerName, $dbUsername, $dbPassword, $dbName);

    setcookie("loggedIn", true, time() + 3600, '/');

    $sql = 'SELECT * FROM users';
    
    $result = mysqli_query($connection, $sql);
    $resultCheck = mysqli_num_rows($result);

    if ($resultCheck > 0) {
        while ($row = mysqli_fetch_assoc($result)) {
            if ($row['emailAddress'] == $_COOKIE['email'])  {
                setcookie('userId', $row['id'], time()+30*1000, '/');
            }
        }
        
    }
    header('Location: userProfile.php');
}

include_once("../assets/php/databaseHandler.php");

$sql = "SELECT * FROM users";
        
$result = mysqli_query($connection, $sql);

$firstName; $lastName; $email; $aboutMe; $id; 

while ($row = mysqli_fetch_assoc($result)) { 
    if ($row['id'] == $_COOKIE['userId']) {
        $firstName = $row['firstName'];
        $lastName = $row['lastName'];
        $email = $row['emailAddress'];
        $aboutMe = $row['aboutMe'];
        $id = $row['id'];
    }
}

if (file_exists("uploadedImage"))
{

}
echo '
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="../assets/css/userProfile.css">
        <title>User Profile</title>
    </head>';
        echo  '<header>
                 <nav>
                     <span>
                         <a href="learningPaths.php">Learning Paths</a>|
                         <a href="../index.php">Home</a>|
                         <a href="">Profile</a>
                     </span>
                     <span id="login">
                         <a onclick="logout();" >Logout</a>
                     </span>
                 </nav>        
             </header>';


             // PERSONAL HEADER
echo '<body>
        <div id="userHeading">
            <div id="picture">
                <img id="profilePic" src="../assets/photos/default.jpg" alt="user image" width="240px" height="240px">
                <form id="input-image" method="POST">
                    <label>Change profile picture</label>
                    <input type="file" id="file" accept="image/jpeg">
                    <input type="text" readonly id="image-text">
                    <button type="submit">Submit</button>
                </form>
            </div>

            <h1> ' . $firstName . " " . $lastName . '</h1>
        </div>

        <script>
            const handleUpload = () => {
            let inputDiv = document.querySelector("#input-image"),
            input = document.querySelector("#input-image input");

            input.addEventListener("change", () => {
                const file = input.files[0];
                console.log(file);
                const reader = new FileReader();

                reader.addEventListener("load", () =>{ 
                    console.log(reader.result);
                    document.querySelector("#image-text").value = reader.result;
                })

                reader.readAsDataURL(file);


            })
        }
        </script>
';

















        // ABOUT ME
        if ($aboutMe == "") {
            echo '
            <form id="about-me" method="POST" action="../assets/php/submitAboutMe.php">
                <label for="about-me">Please Enter Your About Me</label>
                <textarea cols="80" rows="10" id="about-me" name="about-me" ></textarea>

                <input type="submit" >
            </form>';
        } else {
            echo '
            <span id="aboutme">
                '. $aboutMe .'
            </span>
            ';
        }
        ?>
        <script>
        const logout = () => {
            location.href = "login.php";
            document.cookie = "loggedIn=''; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            document.cookie = "email=''; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            document.cookie = "userId=''; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

        }
        </script>


   </body>
    </html>;

